name: Rollback Kubernetes deployment

on:
  workflow_call:
    inputs:
      project: { required: false, type: string }
      k8s_cluster_name: { required: true, type: string }
      k8s_namespace: { required: true, type: string }
      k8s_deployment_name: { required: true, type: string }
      do_api_token: { required: true, type: string }

jobs:
  rollback:
    runs-on: ubuntu-latest
    steps:
      - name: Setup K8s connection
        uses: ./.github/actions/kube-setup
        with:
          k8s_cluster_name: ${{ inputs.k8s_cluster_name }}
          do_api_token: ${{ inputs.do_api_token }}

      - name: Set current deployment
        id: meta
        run: |
          if [[ "${{ inputs.project }}" == "root" ]]; then
            echo "deployment=${{ inputs.k8s_deployment_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "deployment=${{ inputs.k8s_deployment_name }}-${{ inputs.project }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Rollback to previous revision
        run: |
          echo "⚠️ Manual rollback initiated"
          kubectl rollout undo deployment/${{ steps.meta.outputs.deployment }} \
            --namespace=${{ inputs.k8s_namespace }}
