name: Build and Deploy to Kubernetes

on:
  workflow_call:
    inputs:
      tag: { required: true, type: string }
      subprojects: { required: false, type: string }
    secrets:
      registry: { required: true }
      k8s_cluster_name: { required: true }
      k8s_namespace: { required: true }
      k8s_deployment_name: { required: true }
      do_api_token: { required: true }

env:
  DOCKERFILE: Dockerfile.production

jobs:
  prepare-matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set.outputs.matrix }}
    steps:
      - id: set
        run: |
          if [[ -z "${{ inputs.subprojects }}" || "${{ inputs.subprojects }}" == "" ]]; then
            echo 'matrix={"project":["root"]}' >> $GITHUB_OUTPUT
          else
            matrix=$(echo "${{ inputs.subprojects }}" | jq -R '{project: (split(","))}')
            echo "matrix=$matrix" >> $GITHUB_OUTPUT
          fi

  run-matrix:
    needs: prepare-matrix
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{ fromJson(needs.prepare-matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout code for ${{ matrix.project }}
        uses: actions/checkout@v4

      - name: Set up Docker Buildx for ${{ matrix.project }}
        uses: docker/setup-buildx-action@v3

      - name: Log in to DigitalOcean Container Registry for ${{ matrix.project }}
        uses: docker/login-action@v3
        with:
          registry: ${{ secrets.registry }}
          username: doctl
          password: ${{ secrets.do_api_token }}

      - name: Set project context and Dockerfile path for ${{ matrix.project }}
        id: meta
        shell: bash
        run: |
          if [[ "${{ matrix.project }}" == "root" ]]; then
            echo "context=." >> "$GITHUB_OUTPUT"
            echo "dockerfile=${{ env.DOCKERFILE }}" >> "$GITHUB_OUTPUT"
            echo "image=${{ secrets.registry }}/${{ secrets.k8s_namespace }}/${{ secrets.k8s_deployment_name }}" >> "$GITHUB_OUTPUT"
            echo "deployment=${{ secrets.k8s_deployment_name }}" >> "$GITHUB_OUTPUT"
          else
            echo "context=${{ matrix.project }}" >> "$GITHUB_OUTPUT"
            echo "dockerfile=${{ matrix.project }}/${{ env.DOCKERFILE }}" >> "$GITHUB_OUTPUT"
            echo "image=${{ secrets.registry }}/${{ secrets.k8s_namespace }}/${{ secrets.k8s_deployment_name }}-${{ matrix.project }}" >> "$GITHUB_OUTPUT"
            echo "deployment=${{ secrets.k8s_deployment_name }}-${{ matrix.project }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Build and push Docker image for ${{ matrix.project }}
        uses: docker/build-push-action@v5
        with:
          context: code/${{ steps.meta.outputs.context }}
          file: ${{ steps.meta.outputs.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.image }}:${{ inputs.tag }}
          cache-from: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache
          cache-to: type=registry,ref=${{ steps.meta.outputs.image }}:buildcache,mode=max

      - name: Install doctl for ${{ matrix.project }}
        uses: digitalocean/action-doctl@v2
        with:
          token: ${{ secrets.do_api_token }}

      - name: Fetch kubeconfig for ${{ matrix.project }}
        run: doctl kubernetes cluster kubeconfig save ${{ secrets.k8s_cluster_name }}

      - name: Update Kubernetes deployment for ${{ matrix.project }}
        id: update
        run: |
          kubectl set image deployment/${{ steps.meta.outputs.deployment }} \
            ${{ steps.meta.outputs.deployment }}=${{ steps.meta.outputs.image }}:${{ inputs.tag }} \
            --namespace=${{ secrets.namespace }}

      - name: Wait for rollout to complete for ${{ matrix.project }}
        id: rollout
        continue-on-error: true
        run: |
          kubectl rollout status deployment/${{ steps.meta.outputs.deployment }} \
            --namespace=${{ secrets.namespace }} --timeout=180s

      - name: Rollback and fail pipeline if rollout failed for ${{ matrix.project }}
        if: steps.rollout.outcome == 'failure'
        run: |
          echo "❌ Rollout failed. Rolling back..."
          kubectl rollout undo deployment/${{ steps.meta.outputs.deployment }} \
            --namespace=${{ secrets.namespace }}
          echo "❌ Deployment failed and rollback executed."
          exit 1

      - name: Notify success for ${{ matrix.project }}
        if: steps.rollout.outcome == 'success'
        run: echo "✅ Deployment ${{ steps.meta.outputs.deployment }} succeeded."
